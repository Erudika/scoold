{{- if .Values.ecrHelper.enabled }}
{{- $saName := include "scoold.ecrHelperServiceAccountName" . }}
{{- $accountID := required "ecrHelper.accountId is required when ecrHelper.enabled is true" .Values.ecrHelper.accountId }}
{{- $region := required "ecrHelper.region is required when ecrHelper.enabled is true" .Values.ecrHelper.region }}
{{- $secretName := default (printf "%s-ecr-registry" $region) .Values.ecrHelper.secretName }}
{{- $email := default "support@scoold.com" .Values.ecrHelper.contactEmail }}
{{- $awsSecretName := required "ecrHelper.awsSecretRef.name is required when ecrHelper.enabled is true" .Values.ecrHelper.awsSecretRef.name }}
{{- $awsSecretKey := default "aws_ecr_secret" .Values.ecrHelper.awsSecretRef.key }}
{{- $accessKeyID := required "ecrHelper.accessKeyId is required when ecrHelper.enabled is true" .Values.ecrHelper.accessKeyId }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "scoold.fullname" . }}-ecr-helper
  labels:
    {{- include "scoold.labels" . | nindent 4 }}
spec:
  schedule: {{ quote .Values.ecrHelper.schedule }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "scoold.selectorLabels" . | nindent 12 }}
        spec:
          serviceAccountName: {{ $saName }}
          restartPolicy: Never
          containers:
            - name: ecr-cred-helper
              image: "{{ .Values.ecrHelper.image.repository }}:{{ .Values.ecrHelper.image.tag }}"
              imagePullPolicy: {{ .Values.ecrHelper.image.pullPolicy }}
              env:
                - name: AWS_DEFAULT_REGION
                  value: {{ $region }}
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ $awsSecretName }}
                      key: {{ $awsSecretKey }}
                - name: AWS_ACCESS_KEY_ID
                  value: {{ $accessKeyID }}
              command:
                - /bin/sh
                - -c
              args:
                - |-
                  set -euo pipefail
                  ACCOUNT="{{ $accountID }}"
                  REGION="{{ $region }}"
                  SECRET_NAME="{{ $secretName }}"
                  EMAIL="{{ $email }}"
                  PASSWORD="$(aws ecr get-login-password --region "${REGION}" --registry-ids "${ACCOUNT}")"
                  kubectl delete secret --ignore-not-found "${SECRET_NAME}"
                  kubectl create secret docker-registry "${SECRET_NAME}" \
                    --docker-server="https://${ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com" \
                    --docker-username=AWS \
                    --docker-password="${PASSWORD}" \
                    --docker-email="${EMAIL}"
                  echo "Refreshed secret ${SECRET_NAME}"
{{- end }}
