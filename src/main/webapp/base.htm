#if($isAjaxRequest || false)
	################# PAGINATION AJAX REQUESTS #################
	#if($request.getParameter("page"))
		#if(!$pageMacroCode || $pageMacroCode.trim().isEmpty())
			#set($pageMacroCode = "$!request.getParameter('pageMacroCode')" )
		#end
		#evaluate($pageMacroCode)
		#if($pagenum.longValue() > 10000) #set($pnext = $pagenum.intValue()) #else #set($pnext = $pagenum.intValue() + 1) #end
		<span class="$!{pnext}"/>
		#stop
	#end
    ################ AUTOCOMPLETE AJAX REQUESTS ################
    #if($request.getParameter("q") && $request.getParameter("find"))

		#set($q = $request.getParameter("q"))
        #if($request.getParameter("find") == "locations")
            #foreach($location in $utils.readLocationForKeyword($q.trim()))
                $!{location.name}, $!{location.countryName}| $!{location.adminName1} |$!{location.geoNameId}
            #end
			#stop
        #elseif($request.getParameter("find") == "schools")
            #foreach($showschool in $utils.readAndRepair("school", $utils.findQuery("school", $pagenum, $itemcount, $q.trim())))
                ${showschool.name}|${showschool.location}|$!{showschool.id}
            #end
			#stop
		#elseif($request.getParameter("find") == "classes")
            #foreach($showclass in $utils.readAndRepair("classunit", $utils.findQuery("classunit", $pagenum, $itemcount, $q.trim())))
				${showclass.identifier}|$!lang.get("profile.myclasses.gradyear"): ${showclass.gradyear} |$!{showclass.id}
            #end
			#stop
		#elseif($request.getParameter("find") == "tags")
            #foreach($showtag in $utils.findTags($q.trim(), 7))
				$!{showtag.tag}| |$!{showtag.id}
            #end
			#stop
		#elseif($request.getParameter("find") == "people")
            #foreach($showuser in $utils.readAndRepair("user", $utils.findQuery("user", $pagenum, $itemcount, $q.trim())))
				$!{showuser.name}| |$!{showuser.id}
            #end
			#stop
        #end
	#end
    ################# SPECIAL AJAX REQUESTS #################
    #if($request.getParameter("getaboutviewcode"))
        #showaboutview()
		#stop

	#elseif($request.getParameter("getschoolaboutviewcode"))
        #schoolaboutview()
		#stop

	#elseif($request.getParameter("getmyschoolscode"))
		#myschoolspage($schoollist)
		#stop

	#elseif($request.getParameter("newmessage"))
		#if($request.getParameter("toname") && $request.getParameter("toid"))
			#newmessageform($request.getParameterValues("toname") $request.getParameterValues("toid"))
		#else
			#newmessageform([] [])
		#end
		#stop

	#elseif($request.getParameter("getcommenthtmlcode"))
		#commentbox($!newcomment)
		#stop

	#elseif($request.getParameter("getallcommentscode"))
		#if($request.getParameter("page"))
			#set($Int = 0)
			#set($page = $Int.parseInt($request.getParameter("page")))
		#else
			#set($page = $pagenum.longValue())
		#end
		#if($commentslist && $itemcount.longValue() && $commentslist.size() > 0)
			#paginate($page "\#commentspage(\$commentslist)" $itemcount.longValue() "" "pageless" )
		#end
		#stop

	#elseif($request.getParameter("getreportform"))
		#if($request.getParameter("parentid")  && $request.getParameter("parentid") && $request.getParameter("type"))
			#reportform($request.getParameter("type")
				$request.getParameter("parentid")
				$!request.getParameter("grandparentid")
				$request.getParameter("parentid")
				$!request.getParameter("link"))
		#end
		#stop

	#elseif($request.getParameter("voteup") || $request.getParameter("votedown"))
		$!voteresult
		#stop

	#elseif($request.getParameter("addlabel"))
		$!labeladded
		#stop

	#elseif($request.getParameter("gettranslationhtmlcode"))
		#translationbox($!newtranslation)
		#stop

	#elseif($request.getParameter("getsmallpersonbox"))
		#if($showAjaxUser)
			#smallpersonbox($showAjaxUser)
		#end
		#stop

	#elseif($request.getParameter("sendchat") || $request.getParameter("receivechat"))
		#chatmessages($chatMessages)
		#stop

	#end
	#stop

#elseif($request.getAttribute('javax.servlet.forward.request_uri') == "/feed.xml")
	#stop
#end
<!DOCTYPE html>
<html lang="$currentLocale.language">
    <head>
		#basichead($!DESCRIPTION $!KEYWORDS)
		#mobilehead()
		<link href="$context/opensearch.xml" title="$APPNAME" type="application/opensearchdescription+xml" rel="search"/>
		<link href="$context/feed.xml" rel="alternate" type="application/atom+xml" title="New questions feed" />
		#if ($authenticated && $authUser.favtags && !$authUser.favtags.isEmpty())
			#set($feedkey = $utils.MD5("${authUser.id}${FEED_KEY_SALT}"))
			<link href="$context/feed.xml?id=$authUser.id&amp;key=$feedkey" rel="alternate" type="application/atom+xml" title="Selected questions feed"/>
		#end
		<script src="http://cdnjs.cloudflare.com/ajax/libs/headjs/0.99/head.min.js"></script>
		<!--<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>-->
		#if ($includeGMapsScripts && $includeGMapsScripts == true)
			<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5DVwrEn0bWOjqsgHw5XwpjyujAZSkh9U"></script>
		#end
		#fontfix()
	</head>
    <body>
		#if ($includeFBscripts)
			<div id="fb-root"></div>
			<script type="text/javascript">
				window.fbAsyncInit = function() {
					FB.init({appId: '$FB_APP_ID', version: 'v2.0', status: true, cookie: true, xfbml: false, oauth: true});
				};
				// Load the SDK Asynchronously
				(function(d) {
					var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
					js = d.createElement('script'); js.id = id; js.async = true;
					js.src = "//connect.facebook.com/en_US/sdk.js";
					d.getElementsByTagName('head')[0].appendChild(js);
				}(document));
			</script>
		#end
		<div class="report-dialog jqmWindow rounded5"> <div class="center">#ajaxloading(false) </div></div>
		<div id="main" class="clearfix">
			#infostrip()
			<div id="header" class="ptm">
				<div class="container">
					<div class="left">
						#if ($isMobile)<a href="#" class="next-div-toggle mobile-nav-toggle button-small rounded3 mrm">&dtrif;</a>#end
						<a id="logo" href="$!prefix">$APPNAME</a>
						<span class="logosup">
							#if ($IN_BETA) &nbsp;<code class="smallText" title="Beta">&beta;</code> #end
							#if (!$IN_PRODUCTION && !$IN_DEVELOPMENT)
								<code class="red pictos" title="Environment not configured properly!">!</code>
							#elseif ($IN_DEVELOPMENT)
								<code class="blue pictos" title="Development mode">b</code>
							#end
						</span>
					</div>
					<div id="topnav" class="right mtl $!{mobilehizde}">
					#if ($authenticated)
						#if ($authUser.name)
							<a href="$profilelink/$authUser.id/#stripstr($authUser.name)" title="My profile">$!{authUser.name}</a>
						#end
						|
						<span class="pictos gray">y</span> <a href="$settingslink" title="Settings">$!{lang.get('settings.title')}</a> |
						#if ($request.isUserInRole("mod"))
							#if ($authUser.countNewReports() > 0)
								<span class="notificationbox rounded5">$authUser.countNewReports()</span>
							#else
								<span class="pictos">^</span>
							#end
							<a href="$reportslink" title="Reports">$!lang.get("reports.title")</a> |
						#end
						<span class="pictos">K</span>
						<form method="post" action="$signoutlink" class="inline">
							<fieldset class="inline">
								#sectoken(false)
								<input type="submit" value="$!lang.get('signout')" class="bold button-link"/>
							</fieldset>
						</form>
					#else
						#set($thisuri = $request.getAttribute('javax.servlet.forward.request_uri'))
						#if ($request.getAttribute('javax.servlet.forward.query_string'))
							#set($thisuri = "$!{thisuri}?$!request.getAttribute('javax.servlet.forward.query_string')")
						#end
						#if ($thisuri && $thisuri.startsWith($context))
							#set($thisuri = $thisuri.replaceFirst($context, ""))
						#end

						#if (!$returnto) #set($returnto = $request.getParameter("returnto") ) #end
						#if (!$returnto) #set($returnto = $HOMEPAGE ) #end

						#if ($returnto != $thisuri && !$thisuri.startsWith($signinlink.replaceFirst($context, "")))
							#set($returnto = $thisuri )
						#end
						<a href="${signinlink}?returnto=$!{returnto}" title="Sign in" class="button-small rounded3"><span class="pictos">K</span> $!lang.get("signin.title")</a>
					#end

					#if ($isMobile)
						<div class="mtm">
							#searchbox()
						</div>
					#end
					</div>
				</div>
			</div>
			<div id="nav" class="mediumText p100">
				<div class="container">
					<div class="line">
						<div class="unit size2of3">
							<ul id="nav-list" class="left">
								<li><a href="$questionslink" title="Questions" class="nicebtn rounded3 $!{questionsSelected}">$!lang.get("questions.title")</a></li>
								<li><a href="$peoplelink" title="People" class="nicebtn rounded3 $!{peopleSelected}">$!lang.get("people.title")</a></li>
								<li><a href="$schoolslink" title="Schools" class="nicebtn rounded3 $!{schoolsSelected}">$!lang.get("schools.title")</a></li>
								<li><a href="$classeslink" title="Classes" class="nicebtn rounded3 $!{classesSelected}">$!lang.get("classes.title")</a></li>
								#if ($authenticated)
									<li><a href="$groupslink" title="Groups" class="nicebtn rounded3 $!{groupsSelected}">$!lang.get("groups.title")</a></li>
								#end
							</ul>
						</div>
						<div class="unit size1of3 lastUnit">
							#if (!$isMobile)
								#searchbox()
							#end
						</div>
					</div>
				</div>
			</div>
			<div class="container">
				<div id="content" class="clearfix">
					#parse($path)
				</div>
			</div>
		</div>

		<div id="footer" class="mtl">
				<div class="container">
					<div class="line">
						<div class="unit size4of5">
							<div class="clearfix">
								<a id="cc-icon" rel="license" class="extlink left mrm mbl pts" href="http://creativecommons.org/licenses/by-sa/3.0/">
								</a>
								#set($_liclink = $utils.formatMessage("$!lang.get('license')", '<a class="extlink" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons</a>') )
								<div>$_liclink</div>
								#if ($isMobile)<br/>#end
								<ul class="inline-list">
									<li><a href="$aboutlink" title="About">$!{lang.get('about.title')}</a> &bull;</li>
									<li><a href="$privacylink" title="Privacy">$!{lang.get('privacy.title')}</a> &bull;</li>
									<li><a href="$termslink" title="Terms">$!{lang.get('terms.title')}</a> &bull;</li>
									<li>
										#if ($isMobile)
											<a href="$context/?mobile=false" title="Classic layout">$!{lang.get('classic')}</a>
										#else
											<a href="$context/?mobile=true" title="Mobile layout">$!{lang.get('mobile')}</a>
										#end
									</li>
								</ul>
							</div>
						</div>
						#if ($isMobile)<br/>#end
						<div class="unit size1of5 lastUnit r">
							<span class="mediumText">
								<span class="pictos">G</span>
								<a href="$!languageslink" title="Switch to a different language" class="capitalize">
									$!currentLocale.getDisplayLanguage($currentLocale)
								</a>
							</span>
						</div>
						#if ($isMobile)<br/>#end
					</div>
				</div>
		</div>

		#set($sectoken = "#sectoken(true)")
		#set($sectoken = $sectoken.trim())
		#set($_langjs = "#langjs()")
		<script type="text/javascript">
			/* <![CDATA[ */
			function loadScripts(scriptslink, minsuffix) {
				head.js (
					{jquery:		"http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js" },
					{validate:		"http://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.10.0/jquery.validate.min.js" },
					{modal:			"http://cdn.jsdelivr.net/jqmodal/0.1/jqModal.js" },
					{jeditable:		"http://cdnjs.cloudflare.com/ajax/libs/jeditable.js/1.7.3/jeditable.min.js" },
					{autocomplete:	scriptslink + "/jquery.autocomplete" + minsuffix + ".js" },
					{markitup:		scriptslink + "/jquery.markitup" + minsuffix + ".js" },
//					{miuicons:		scriptslink + "/miu.set.markdown" + minsuffix + ".js" },
					{showdown:		"http://cdnjs.cloudflare.com/ajax/libs/showdown/0.3.1/showdown.min.js" },
					{diff:			"http://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js" },
					{scoold:		scriptslink + "/scoold" + minsuffix + ".js" });
			}

			var lang = $_langjs,
				sessiontimeout = $SESSION_TIMEOUT_SEC,
				userip = "$!userip",
				csrftoken = "$!sectoken";
			loadScripts("$!scriptslink", "$!minsuffix");
			/* ]]> */
		</script>
    </body>
</html>